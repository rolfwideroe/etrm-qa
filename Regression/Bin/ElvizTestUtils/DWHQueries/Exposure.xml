<DbQuery>
	<Columns>
		<Column ColumnName="Portfolio" ColumnDataType="System.String"/>
		<Column ColumnName="Commodity" ColumnDataType="System.String"/>
		<Column ColumnName="Instrument" ColumnDataType="System.String"/>
		<Column ColumnName="FromDate" ColumnDataType="System.DateTime"/>
		<Column ColumnName="ToDate" ColumnDataType="System.DateTime"/>
		<Column ColumnName="InstrumentType" ColumnDataType="System.String"/>
		<Column ColumnName="DeliveryType" ColumnDataType="System.String"/>
		<Column ColumnName="LoadType" ColumnDataType="System.String"/>
		<Column ColumnName="PositionPriceBasis" ColumnDataType="System.String"/>
		<Column ColumnName="ExecutionVenue" ColumnDataType="System.String"/>
		<Column ColumnName="PositonTimeZone" ColumnDataType="System.String"/>
		<Column ColumnName="PositionCurrency" ColumnDataType="System.String"/>
		<Column ColumnName="ExternalIds" ColumnDataType="System.String"/>
		<Column ColumnName="ExposurePriceBasis" ColumnDataType="System.String"/>
		<Column ColumnName="ExposureUnit" ColumnDataType="System.String"/>
		<Column ColumnName="ExposureFromTime" ColumnDataType="System.DateTime"/>
		<Column ColumnName="ExposureToTime" ColumnDataType="System.DateTime"/>
		<Column ColumnName="BaseExposure" ColumnDataType="System.Double"/>
		<Column ColumnName="PeakExposure" ColumnDataType="System.Double"/>
		<Column ColumnName="OffPeakExposure" ColumnDataType="System.Double"/>
	</Columns>
	<SqlQuery>
	<![CDATA[
		DECLARE @workspace varchar(255)
		DECLARE @monitor varchar(255)
		DECLARE @reportDate varchar(255)

		set @workspace='{workspace}'
		set @monitor='{monitor}'
		set @reportDate='{reportdate}'

			declare @mappingTable TABLE (TransIds NVARCHAR(4000),ExtIds VARCHAR(4000))
		insert into @mappingTable
		SELECT 
		c.RMC_TransactionIds,dbo.ufn_TransIdCsvToExtIdCsv(c.RMC_TransactionIds) AS ExtIds
		  FROM RMC_Contracts c

			WHERE c.RMC_RMR_ID=(
								SELECT [RMR_ID] FROM [RMR_ReportHeader] 
								WHERE [RMR_Workspace]=@workspace
								AND [RMR_FrmName]=@monitor
								AND [RMR_RpDate]=@reportDate
								)

	   declare @extIdTable TABLE (TransIds NVARCHAR(4000),ExtIds VARCHAR(4000))
	
	   insert into @extIdTable
	   SELECT m.TransIds,m.ExtIds FROM @mappingTable m GROUP BY m.TransIds,m.ExtIds	
			
	
		


			SELECT 

			   c.RMC_PortfolioName as Portfolio
			   ,c.RMC_Commodity as Commodity
			   ,c.RMC_Instrument as Instrument
			   ,c.RMC_InstPerFrom as FromDate
			   ,c.RMC_InstPerTo as ToDate
			   ,c.RMC_InstType as InstrumentType
			   ,c.RMC_DelType as DeliveryType
			  ,c.RMC_LoadType as LoadType
			  ,c.RMC_Pricebasis as PositionPriceBasis
			  ,c.RMC_Executionvenue as ExecutionVenue
			  ,c.RMC_TimeZone as PositonTimeZone
			  ,c.RMC_Currency as PositionCurrency
			  			   
			   ,ext.ExtIds as ExternalIds
			   
			   ,e.RMV_PriceBasisName as ExposurePriceBasis
			   ,e.RMV_Unit as ExposureUnit
			  ,e.RMV_FromTime as ExposureFromTime
			  ,e.RMV_UntilTime as ExposureToTime
			  ,e.RMV_Exposure as BaseExposure
			  ,e.RMV_PeakExposure as PeakExposure
			  ,e.RMV_OffPeakExposure as OffPeakExposure


		  FROM RMC_Contracts c
		  left JOIN @extIdTable ext
		  ON ext.TransIds=c.RMC_TransactionIds
		  JOIN RMV_Values e 
		  ON c.RMC_ContractId=e.RMV_RMC_ContractId



			WHERE c.RMC_RMR_ID=(
								SELECT [RMR_ID] FROM [RMR_ReportHeader] 
								WHERE [RMR_Workspace]=@workspace
								AND [RMR_FrmName]=@monitor
								AND [RMR_RpDate]=@reportDate
							)
		-- AND not (e.RMV_Exposure = 0 and RMV_PeakExposure =0 and e.RMV_OffPeakExposure =0)
		 and e.RMV_Exposure <> 0
		 ORDER BY ext.ExtIds,c.RMC_Instrument, e.RMV_PriceBasisName,e.RMV_FromTime
	]]>
	</SqlQuery>
</DbQuery>