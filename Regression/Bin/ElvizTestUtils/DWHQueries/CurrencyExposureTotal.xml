<DbQuery>
	<Columns>
		<Column ColumnName="ExternalIds" ColumnDataType="System.String"/>
		<Column ColumnName="ExposureAgainstCurrency" ColumnDataType="System.String"/>
		<Column ColumnName="CurrencyExposure" ColumnDataType="System.Double"/>
	</Columns>
	<SqlQuery>
	<![CDATA[
		DECLARE @workspace varchar(255)
		DECLARE @monitor varchar(255)
		DECLARE @reportDate varchar(255)

		set @workspace='{workspace}'
		set @monitor='{monitor}'
		set @reportDate='{reportdate}'

		declare @mappingTable TABLE (TransIds NVARCHAR(4000),ExtIds VARCHAR(4000))
		insert into @mappingTable
		SELECT 
		c.RCC_TransactionIds,dbo.ufn_TransIdCsvToExtIdCsv(c.RCC_TransactionIds) AS ExtIds
		  FROM RCC_Contracts c

				WHERE c.RCC_RCR_ID=(
								SELECT RCR_ID FROM RCR_ReportHeader 
								WHERE RCR_Workspace=@workspace
								AND RCR_FrmName=@monitor
								AND RCR_RpDate=@reportDate
							)

	   declare @extIdTable TABLE (TransIds NVARCHAR(4000),ExtIds VARCHAR(4000))
	
	   insert into @extIdTable
	   SELECT m.TransIds,m.ExtIds FROM @mappingTable m GROUP BY m.TransIds,m.ExtIds	
			
	
		


			SELECT 


			  			   
			   ext.ExtIds as ExternalIds
			   
			  ,e.RCV_Currency as ExposureAgainstCurrency

			  ,SUM(e.RCV_CurrencyExposure) CurrencyExposure

		  FROM RCC_Contracts c
		  left JOIN @extIdTable ext
		  ON ext.TransIds=c.RCC_TransactionIds
		  lEFT JOIN RCV_Values e 
		  ON c.RCC_ContractId=e.RCV_RCC_ContractId


			WHERE c.RCC_RCR_ID=(
								SELECT RCR_ID FROM RCR_ReportHeader 
								WHERE RCR_Workspace=@workspace
								AND RCR_FrmName=@monitor
								AND RCR_RpDate=@reportDate
							)

		 --and e.RCV_CurrencyExposure = 0
		 GROUP BY ext.ExtIds,e.RCV_Currency 
		 ORDER BY ext.ExtIds,e.RCV_Currency 
	]]>
	</SqlQuery>
</DbQuery>